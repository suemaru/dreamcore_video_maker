<!--
ファイル構造:
your-project/
├── index.html (このファイル)
└── assets/
    └── bg_format.png (背景画像 - 2000x2000px、自動的に1000x1000pxにリサイズされます)

使用方法:
1. assetsフォルダを作成
2. bg_format.png（2000x2000px）を配置
3. ブラウザでindex.htmlを開く

注意: 背景画像は自動的に1000x1000pxにリサイズされ、
座標は1000px基準で計算されます。
-->
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DreamCore Video Generator</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        // アイコンコンポーネント（簡易版）
        const Upload = () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" /></svg>;
        const Download = () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>;
        const Play = () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M14.828 14.828a4 4 0 01-5.656 0M9 10h1.586a1 1 0 01.707.293l2.414 2.414a1 1 0 00.707.293H15" /></svg>;
        const Sparkles = () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 3a2 2 0 00-2 2v1c0 8.284 6.716 15 15 15h1a2 2 0 002-2V4a2 2 0 00-2-2H5z" /></svg>;
        const Gamepad2 = () => <svg className="w-16 h-16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M14.828 14.828a4 4 0 01-5.656 0M9 10h1.586a1 1 0 01.707.293l2.414 2.414a1 1 0 00.707.293H15" /></svg>;
        const Video = () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>;
        const Link = () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" /></svg>;
        const Image = () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>;
        const Type = () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 21h10v-2H7v2zM21 9h-8v6h8V9zM3 9h8v6H3V9z" /></svg>;
        const User = () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>;

        const DreamCoreVideoGenerator = () => {
            const [currentStep, setCurrentStep] = useState(0);
            const [gameData, setGameData] = useState(null);
            const [videoFile, setVideoFile] = useState(null);
            const [isProcessing, setIsProcessing] = useState(false);
            const [progress, setProgress] = useState(0);
            const [outputVideo, setOutputVideo] = useState(null);
            const [outputVideoMimeType, setOutputVideoMimeType] = useState(null);
            const [errorMessage, setErrorMessage] = useState('');
            const [manualData, setManualData] = useState({
                title: '',
                description: '',
                coverImage: null,
                accountImage: null
            });

            const videoRef = useRef(null);
            const canvasRef = useRef(null);
            const fileInputRef = useRef(null);
            const coverImageRef = useRef(null);
            const accountImageRef = useRef(null);

            // ステップ定義
            const steps = [
                { title: 'ゲーム情報', icon: Type },
                { title: '動画アップロード', icon: Video },
                { title: 'プレビュー', icon: Play },
                { title: '生成', icon: Download }
            ];



            // 手動データの送信
            const handleManualDataSubmit = () => {
                if (!manualData.title || !manualData.description) {
                    alert('タイトルと説明文は必須です');
                    return;
                }
                setGameData(manualData);
                setCurrentStep(1);
            };

            // 動画ファイルの処理
            const handleVideoUpload = (event) => {
                const file = event.target.files[0];
                if (file && file.type.startsWith('video/')) {
                    setVideoFile(file);
                    setCurrentStep(2);
                } else {
                    alert('動画ファイルを選択してください');
                }
            };

            // 画像ファイルの処理（改善版）
            const handleImageUpload = (event, type) => {
                const file = event.target.files[0];
                if (file) {
                    // サポートされている形式をチェック
                    const supportedTypes = ['image/png', 'image/jpeg', 'image/jpg', 'image/gif'];
                    if (!supportedTypes.includes(file.type)) {
                        alert('PNG, JPEG, GIF形式の画像をアップロードしてください。WebP形式はサポートされていません。');
                        event.target.value = ''; // ファイル選択をリセット
                        return;
                    }
                    
                    if (file.type.startsWith('image/')) {
                        // blob URLではなく、ファイル自体を保存
                        setManualData(prev => ({
                            ...prev,
                            [type]: file  // fileオブジェクト自体を保存
                        }));
                        console.log(`${type}アップロード成功:`, file.type, file.size);
                    } else {
                        alert('画像ファイルを選択してください');
                    }
                }
            };

            // 動画生成処理
            const generateVideo = async () => {
                if (!videoFile || !gameData) return;

                setIsProcessing(true);
                setProgress(0);
                setCurrentStep(3);
                setErrorMessage('');

                try {
                    // プログレスバーのアニメーション
                    const progressAnimation = async () => {
                        for (let i = 0; i <= 90; i += 10) {
                            setProgress(i);
                            await new Promise(resolve => setTimeout(resolve, 200));
                        }
                    };
                    progressAnimation();

                    // Canvas での動画合成処理
                    const canvas = canvasRef.current;
                    const ctx = canvas.getContext('2d');
                    canvas.width = 1000;  // 1000x1000に変更
                    canvas.height = 1000;

                    // 背景画像を読み込み
                    const backgroundImg = await new Promise((resolve, reject) => {
                        const img = document.createElement('img');
                        
                        img.addEventListener('load', () => resolve(img));
                        img.addEventListener('error', () => {
                            console.log('背景画像が見つかりません。デフォルト背景を使用します。');
                            // デフォルト背景を作成
                            const canvas = document.createElement('canvas');
                            canvas.width = 1000;  // 1000x1000に変更
                            canvas.height = 1000;
                            const ctx = canvas.getContext('2d');
                            ctx.fillStyle = '#FF6B35';
                            ctx.fillRect(0, 0, 1000, 1000);
                            
                            // DreamCoreロゴエリア（左上）
                            ctx.fillStyle = '#FFFFFF';
                            ctx.font = 'bold 30px Arial';  // サイズ調整（60/2）
                            ctx.fillText('DreamCore', 55, 92);  // 座標調整（111/2, 185/2）
                            ctx.fillText('×', 222, 92);  // 座標調整（444/2, 185/2）
                            
                            // ピンク枠の描画（左側）
                            ctx.fillStyle = '#FF1493';
                            ctx.fillRect(111, 312, 370, 520);  // 座標・サイズ調整（全て半分）
                            
                            // 青枠の描画（右側）
                            ctx.fillStyle = '#1E90FF';
                            ctx.fillRect(532, 129, 463, 740);  // 座標・サイズ調整（全て半分）
                            
                            const defaultImg = document.createElement('img');
                            defaultImg.addEventListener('load', () => resolve(defaultImg));
                            defaultImg.src = canvas.toDataURL();
                        });
                        
                        // CORS問題を回避するため、同一オリジンでのみ読み込み
                        img.src = './assets/bg_format.png';
                    });

                    // ユーザーがアップロードした動画を読み込み
                    const videoElement = document.createElement('video');
                    videoElement.src = URL.createObjectURL(videoFile);
                    videoElement.muted = true;
                    videoElement.loop = true;

                    // 動画の読み込み完了を待機
                    await new Promise((resolve, reject) => {
                        videoElement.onloadedmetadata = resolve;
                        videoElement.onerror = reject;
                        setTimeout(reject, 10000); // 10秒でタイムアウト
                    });

                    // 画像の読み込み（CORS問題対応）
                    const loadImage = (src) => {
                        return new Promise((resolve, reject) => {
                            const img = document.createElement('img');
                            
                            img.addEventListener('load', () => resolve(img));
                            img.addEventListener('error', () => {
                                console.log('画像読み込み失敗、デフォルト画像を作成:', src);
                                // デフォルト画像を作成
                                const canvas = document.createElement('canvas');
                                canvas.width = 400;
                                canvas.height = 400;
                                const ctx = canvas.getContext('2d');
                                ctx.fillStyle = '#ddd';
                                ctx.fillRect(0, 0, 400, 400);
                                ctx.fillStyle = '#999';
                                ctx.font = '20px Arial';
                                ctx.textAlign = 'center';
                                ctx.fillText('画像', 200, 200);
                                
                                const defaultImg = document.createElement('img');
                                defaultImg.addEventListener('load', () => resolve(defaultImg));
                                defaultImg.src = canvas.toDataURL();
                            });
                            
                            // ローカルファイルの場合はcrossOriginを設定しない
                            if (!src.startsWith('http')) {
                                img.src = src;
                            } else {
                                // 外部URLの場合のみcrossOriginを設定（ただし失敗する可能性が高い）
                                try {
                                    img.crossOrigin = 'anonymous';
                                    img.src = src;
                                } catch (e) {
                                    console.log('crossOrigin設定失敗、代替画像を使用');
                                    // 代替として空の画像を作成
                                    const canvas = document.createElement('canvas');
                                    canvas.width = 400;
                                    canvas.height = 400;
                                    const ctx = canvas.getContext('2d');
                                    ctx.fillStyle = '#f0f0f0';
                                    ctx.fillRect(0, 0, 400, 400);
                                    
                                    const fallbackImg = document.createElement('img');
                                    fallbackImg.addEventListener('load', () => resolve(fallbackImg));
                                    fallbackImg.src = canvas.toDataURL();
                                }
                            }
                        });
                    };

                    // FileReader を使用して画像ファイルを読み込み
                    const loadImageFromFile = (file) => {
                        return new Promise((resolve, reject) => {
                            const reader = new FileReader();
                            reader.addEventListener('load', (e) => {
                                const img = document.createElement('img');
                                img.addEventListener('load', () => resolve(img));
                                img.addEventListener('error', reject);
                                img.src = e.target.result;
                            });
                            reader.addEventListener('error', reject);
                            reader.readAsDataURL(file);
                        });
                    };

                    let coverImg = null;
                    let accountImg = null;

                    // カバー画像の読み込み処理
                    if (gameData.coverImage) {
                        try {
                            if (gameData.coverImage instanceof File) {
                                // アップロードされたファイルの場合
                                console.log('カバー画像をFileReaderで読み込み中...');
                                coverImg = await loadImageFromFile(gameData.coverImage);
                                console.log('カバー画像読み込み成功');
                            } else if (typeof gameData.coverImage === 'string') {
                                // 外部URLまたはデモ画像の場合
                                console.log('カバー画像をURLから読み込み中:', gameData.coverImage);
                                coverImg = await loadImage(gameData.coverImage);
                                console.log('カバー画像読み込み成功');
                            }
                        } catch (e) {
                            console.log('カバー画像の読み込みに失敗:', e);
                        }
                    } else {
                        console.log('カバー画像が設定されていません');
                    }

                    // アカウント画像の読み込み処理
                    if (gameData.accountImage) {
                        try {
                            if (gameData.accountImage instanceof File) {
                                // アップロードされたファイルの場合
                                console.log('アカウント画像をFileReaderで読み込み中...');
                                accountImg = await loadImageFromFile(gameData.accountImage);
                                console.log('アカウント画像読み込み成功');
                            } else if (typeof gameData.accountImage === 'string') {
                                // 外部URLまたはデモ画像の場合
                                console.log('アカウント画像をURLから読み込み中:', gameData.accountImage);
                                accountImg = await loadImage(gameData.accountImage);
                                console.log('アカウント画像読み込み成功');
                            }
                        } catch (e) {
                            console.log('アカウント画像の読み込みに失敗:', e);
                        }
                    } else {
                        console.log('アカウント画像が設定されていません');
                    }

                    // 動画の描画関数
                    const drawFrame = () => {
                        // 背景画像のサイズをログ出力（デバッグ用）
                        console.log('描画時の背景画像サイズ:', backgroundImg.width, 'x', backgroundImg.height);
                        
                        // 背景画像を描画（2000x2000を1000x1000に縮小描画）
                        ctx.drawImage(backgroundImg, 0, 0, 1000, 1000);

                        // アカウント画像の描画（円形、x:376 y:200中心、直径140px）
                        if (accountImg) {
                            console.log('アカウント画像を描画中...');
                            const accountX = 376;   // 中心X座標（753/2）
                            const accountY = 200;   // 中心Y座標（400/2）
                            const accountRadius = 70; // 半径（直径140px）
                            
                            // 外側のボーダー（白、2px）
                            ctx.save();
                            ctx.beginPath();
                            ctx.arc(accountX, accountY, accountRadius + 2, 0, 2 * Math.PI);
                            ctx.fillStyle = '#ffffff';
                            ctx.fill();
                            
                            // 画像を円形にクリップして描画
                            ctx.beginPath();
                            ctx.arc(accountX, accountY, accountRadius, 0, 2 * Math.PI);
                            ctx.clip();
                            ctx.drawImage(accountImg, accountX - accountRadius, accountY - accountRadius, 
                                        accountRadius * 2, accountRadius * 2);
                            ctx.restore();
                        } else {
                            console.log('アカウント画像がありません');
                            // デバッグ用の円を描画
                            ctx.strokeStyle = '#FF0000';
                            ctx.lineWidth = 3;
                            ctx.beginPath();
                            ctx.arc(376, 200, 70, 0, 2 * Math.PI);
                            ctx.stroke();
                        }

                        // カバー画像の描画（x:241 y:308が上端中心、高さ485px、縦横比保持）
                        if (coverImg) {
                            console.log('カバー画像を描画中...');
                            const targetHeight = 485;  // 970/2
                            const aspectRatio = coverImg.width / coverImg.height;
                            const targetWidth = targetHeight * aspectRatio;
                            
                            const coverX = 241 - (targetWidth / 2); // 中心から左端を計算（483/2）
                            const coverY = 308; // 上端（617/2）
                            
                            // 外側のボーダー（白、2px）
                            ctx.fillStyle = '#ffffff';
                            ctx.fillRect(coverX - 2, coverY - 2, targetWidth + 4, targetHeight + 4);
                            
                            // 画像を描画
                            ctx.drawImage(coverImg, coverX, coverY, targetWidth, targetHeight);
                        } else {
                            console.log('カバー画像がありません');
                            // デバッグ用の矩形を描画
                            ctx.strokeStyle = '#FF0000';
                            ctx.lineWidth = 3;
                            ctx.strokeRect(241 - 100, 308, 200, 485);
                        }

                        // ユーザーの動画を描画（x:700 y:500中心、幅400px、縦横比保持）
                        if (videoElement.readyState >= 2) {
                            try {
                                const targetWidth = 400;  // 800/2
                                const aspectRatio = videoElement.videoHeight / videoElement.videoWidth;
                                const targetHeight = targetWidth * aspectRatio;
                                
                                const videoX = 700 - (targetWidth / 2); // 中心から左端を計算（1400/2）
                                const videoY = 500 - (targetHeight / 2); // 中心から上端を計算（1000/2）
                                
                                // 外側のボーダー（白、2px）
                                ctx.fillStyle = '#ffffff';
                                ctx.fillRect(videoX - 2, videoY - 2, targetWidth + 4, targetHeight + 4);
                                
                                // 動画を描画
                                ctx.drawImage(videoElement, videoX, videoY, targetWidth, targetHeight);
                            } catch (e) {
                                console.log('動画描画エラー:', e);
                                // デバッグ用の矩形を描画
                                ctx.strokeStyle = '#FF0000';
                                ctx.lineWidth = 3;
                                ctx.strokeRect(700 - 200, 500 - 150, 400, 300);
                            }
                        }

                        // ゲームタイトルの描画（x:241 y:843中心、中央揃え）
                        ctx.fillStyle = '#FFFFFF';
                        ctx.font = 'bold 33px Arial';  // 66/2
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        const titleX = 241;  // 483/2
                        const titleY = 843;  // 1686/2
                        ctx.fillText(gameData.title, titleX, titleY);

                        // 説明文の描画（x:241 y:879を1行目中心、中央揃え、改行対応）
                        ctx.font = '22px Arial';  // 44/2
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'top';
                        const descX = 241;  // 483/2
                        let descY = 879 - 11; // フォントサイズの半分を引いて中心調整（1759/2）
                        
                        // 改行処理（日本語対応）
                        const maxWidth = 400; // 最大幅（1500/2）
                        const lineHeight = 25; // 行間（55/2）
                        const lines = [];
                        let line = '';
                        
                        // 日本語・英語両対応の改行処理
                        for (let i = 0; i < gameData.description.length; i++) {
                            const char = gameData.description[i];
                            const testLine = line + char;
                            const metrics = ctx.measureText(testLine);
                            const testWidth = metrics.width;
                            
                            if (testWidth > maxWidth && line.length > 0) {
                                // 改行位置の調整（句読点の後で改行するとより自然）
                                lines.push(line);
                                line = char;
                            } else {
                                line = testLine;
                            }
                        }
                        if (line.length > 0) {
                            lines.push(line);
                        }
                        
                        // 各行を描画
                        lines.forEach((line, index) => {
                            ctx.fillText(line.trim(), descX, descY + (index * lineHeight));
                        });
                    };

                    // 初期フレームを描画
                    drawFrame();
                    console.log('初期フレーム描画完了');

                    // Canvas の origin-clean 状態をチェック
                    try {
                        // テスト用に小さなImageDataを取得してみる
                        const testData = ctx.getImageData(0, 0, 1, 1);
                        console.log('Canvas は origin-clean です');
                        console.log('Canvas サイズ:', canvas.width, 'x', canvas.height);
                    } catch (securityError) {
                        console.error('Canvas が origin-clean ではありません:', securityError);
                        throw new Error('画像のセキュリティ制限により動画生成ができません。ローカルHTTPサーバーを使用してください。');
                    }

                    // MediaRecorder で動画として出力（解像度を明示的に指定）
                    const canvasStream = canvas.captureStream(30);
                    console.log('Canvas stream 取得成功');
                    
                    // ストリームの解像度を確認
                    const videoTrack = canvasStream.getVideoTracks()[0];
                    const settings = videoTrack.getSettings();
                    console.log('Stream 解像度:', settings.width, 'x', settings.height);
                    
                    // 音声ストリームを取得（アップロード動画から）
                    let finalStream = canvasStream;
                    let tempVideo = null; // 音声用の動画要素
                    
                    try {
                        // 動画ファイルのストリームを作成
                        tempVideo = document.createElement('video');
                        tempVideo.src = URL.createObjectURL(videoFile);
                        tempVideo.muted = false; // 音声を有効化
                        tempVideo.loop = true; // ループ再生で同期を保つ
                        
                        // 動画が読み込まれるまで待機
                        await new Promise((resolve, reject) => {
                            tempVideo.onloadedmetadata = resolve;
                            tempVideo.onerror = reject;
                            setTimeout(reject, 5000); // 5秒でタイムアウト
                        });
                        
                        // MediaStreamを作成して音声トラックを取得
                        if (tempVideo.captureStream) {
                            const videoMediaStream = tempVideo.captureStream();
                            const audioTracks = videoMediaStream.getAudioTracks();
                            
                            if (audioTracks.length > 0) {
                                console.log('音声トラック検出:', audioTracks.length + '個');
                                
                                // 新しいMediaStreamを作成して音声とビデオを合成
                                const combinedStream = new MediaStream();
                                
                                // ビデオトラックを追加
                                canvasStream.getVideoTracks().forEach(track => {
                                    combinedStream.addTrack(track);
                                });
                                
                                // 音声トラックを追加
                                audioTracks.forEach(track => {
                                    combinedStream.addTrack(track);
                                });
                                
                                finalStream = combinedStream;
                                console.log('音声付きストリーム作成成功');
                                
                                // 一時的な動画要素を再生（音声同期のため）
                                tempVideo.currentTime = 0;
                                await tempVideo.play();
                            } else {
                                console.log('音声トラックが見つかりません');
                            }
                        } else {
                            console.log('captureStream()がサポートされていません');
                        }
                        
                    } catch (audioError) {
                        console.log('音声トラック取得に失敗、ビデオのみで録画:', audioError);
                        // 音声なしでも録画は続行
                    }
                    
                    // ブラウザ対応の確認（MP4を優先）
                    let mimeType = 'video/mp4';
                    if (typeof MediaRecorder === 'undefined') {
                        throw new Error('このブラウザは動画録画をサポートしていません');
                    }
                    
                    if (!MediaRecorder.isTypeSupported(mimeType)) {
                        mimeType = 'video/webm;codecs=vp8';
                        if (!MediaRecorder.isTypeSupported(mimeType)) {
                            mimeType = 'video/webm';
                        }
                    }
                    
                    console.log('使用するMIMEタイプ:', mimeType);

                    // MediaRecorderの設定で解像度を明示的に指定
                    const mediaRecorder = new MediaRecorder(finalStream, { 
                        mimeType,
                        videoBitsPerSecond: 8000000  // 8Mbps（高品質）
                    });
                    
                    const chunks = [];
                    mediaRecorder.ondataavailable = (event) => {
                        if (event.data.size > 0) {
                            chunks.push(event.data);
                        }
                    };

                    mediaRecorder.onstop = () => {
                        try {
                            const blob = new Blob(chunks, { type: mimeType });
                            const url = URL.createObjectURL(blob);
                            console.log('動画生成完了 - Blob サイズ:', blob.size, 'bytes');
                            console.log('MIMEタイプ:', blob.type);
                            setOutputVideo(url);
                            setOutputVideoMimeType(mimeType);
                            setProgress(100);
                            setIsProcessing(false);
                        } catch (e) {
                            console.error('動画保存エラー:', e);
                            setErrorMessage('動画の保存に失敗しました');
                            setIsProcessing(false);
                        }
                    };

                    // 動画の再生開始（エラーハンドリング強化）
                    try {
                        await videoElement.play();
                        console.log('動画再生開始成功');
                    } catch (playError) {
                        console.log('動画自動再生に失敗、手動再生を試行:', playError);
                        // 自動再生に失敗した場合でも録画は開始
                    }

                    // 少し待ってから録画開始（Canvasが安定するまで）
                    await new Promise(resolve => setTimeout(resolve, 500));

                    // 録画開始
                    mediaRecorder.start(100);
                    console.log('録画開始 - 解像度:', canvas.width, 'x', canvas.height);

                    // フレーム描画のループ
                    let frameCount = 0;
                    const animate = () => {
                        drawFrame();
                        frameCount++;
                        
                        // 動画が再生中、または最大フレーム数に達するまで続行
                        if ((!videoElement.paused && !videoElement.ended) || frameCount < 450) { // 15秒 × 30fps
                            requestAnimationFrame(animate);
                        }
                    };
                    animate();

                    // 動画の長さまたは最大15秒で録画停止
                    const maxDuration = Math.min(videoElement.duration * 1000 || 15000, 15000);
                    console.log('録画時間設定:', maxDuration + 'ms');
                    
                    setTimeout(() => {
                        console.log('録画停止 - 総フレーム数:', frameCount);
                        mediaRecorder.stop();
                        videoElement.pause();
                        
                        // 音声用の動画要素も停止・クリーンアップ
                        if (tempVideo) {
                            tempVideo.pause();
                            URL.revokeObjectURL(tempVideo.src);
                            console.log('音声用動画要素をクリーンアップ');
                        }
                    }, maxDuration);

                } catch (error) {
                    console.error('動画生成エラー:', error);
                    setErrorMessage('動画の生成に失敗しました: ' + error.message);
                    setIsProcessing(false);
                    
                    // エラー時のクリーンアップ
                    if (tempVideo) {
                        tempVideo.pause();
                        URL.revokeObjectURL(tempVideo.src);
                    }
                }
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900">
                    {/* ヒーローセクション */}
                    <div className="relative overflow-hidden">
                        <div className="absolute inset-0 bg-gradient-to-r from-purple-500/20 to-pink-500/20"></div>
                        <div className="relative container mx-auto px-6 py-20">
                            <div className="text-center">
                                <div className="flex justify-center items-center mb-6">
                                    <h1 className="text-5xl font-bold bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent">
                                        DreamCore Video Generator
                                    </h1>
                                </div>
                                <p className="hidden md:block text-xl text-gray-300 mb-8 max-w-2xl mx-auto">
                                    DreamCoreで作ったゲームの紹介動画を簡単生成！
                                </p>
                                
                                {/* ステップインジケーター */}
                                <div className="flex justify-center items-center mb-12 px-2 md:px-0">
                                    {steps.map((step, index) => {
                                        const Icon = step.icon;
                                        const isActive = index === currentStep;
                                        const isCompleted = index < currentStep;
                                        
                                        return (
                                            <div key={index} className="flex flex-col md:flex-row items-center flex-1 md:flex-none">
                                                <div className={`
                                                    flex items-center justify-center w-8 h-8 md:w-12 md:h-12 rounded-full border-2 transition-all duration-300
                                                    ${isActive ? 'border-purple-400 bg-purple-400 text-white' : 
                                                      isCompleted ? 'border-green-400 bg-green-400 text-white' : 'border-gray-600 text-gray-400'}
                                                `}>
                                                    <Icon />
                                                </div>
                                                                                <span className={`mt-1 md:mt-0 md:ml-2 md:mr-3 text-center text-xs md:text-base ${isActive ? 'text-purple-400' : 'text-gray-400'}`}>
                                    {step.title}
                                </span>
                                {index < steps.length - 1 && (
                                    <div className={`hidden md:block w-8 h-0.5 mr-3 ${isCompleted ? 'bg-green-400' : 'bg-gray-600'}`}></div>
                                )}
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        </div>
                    </div>
                    


                    {/* メインコンテンツ */}
                    <div className="container mx-auto px-6 pb-20">
                        <div className="max-w-4xl mx-auto">
                            
                            {/* ステップ0: ゲーム情報入力 */}
                            {currentStep === 0 && (
                                <div className="bg-slate-800/50 backdrop-blur-sm rounded-2xl p-8 border border-slate-700">
                                    <h2 className="text-2xl font-bold text-white mb-6 flex items-center">
                                        <Type />
                                        <span className="ml-3">ゲーム情報を入力</span>
                                    </h2>
                                    
                                    <div className="space-y-6">
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                            <div>
                                                <label className="block text-gray-300 mb-2">ゲームタイトル</label>
                                                <input
                                                    type="text"
                                                    value={manualData.title}
                                                    onChange={(e) => setManualData(prev => ({...prev, title: e.target.value}))}
                                                    className="w-full p-3 bg-slate-700 text-white rounded-lg border border-slate-600 focus:border-purple-400 focus:outline-none"
                                                    placeholder="ゲームタイトルを入力"
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-gray-300 mb-2">説明文</label>
                                                <input
                                                    type="text"
                                                    value={manualData.description}
                                                    onChange={(e) => setManualData(prev => ({...prev, description: e.target.value}))}
                                                    className="w-full p-3 bg-slate-700 text-white rounded-lg border border-slate-600 focus:border-purple-400 focus:outline-none"
                                                    placeholder="ゲームの説明"
                                                />
                                            </div>
                                        </div>
                                        
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                            <div>
                                                <label className="block text-gray-300 mb-2">カバー画像</label>
                                                <input
                                                    ref={coverImageRef}
                                                    type="file"
                                                    accept="image/png,image/jpeg,image/jpg,image/gif"
                                                    onChange={(e) => handleImageUpload(e, 'coverImage')}
                                                    className="w-full p-3 bg-slate-700 text-white rounded-lg border border-slate-600"
                                                />
                                                <p className="text-xs text-gray-400 mt-1">PNG, JPEG, GIF対応</p>
                                            </div>
                                            <div>
                                                <label className="block text-gray-300 mb-2">アカウント画像</label>
                                                <input
                                                    ref={accountImageRef}
                                                    type="file"
                                                    accept="image/png,image/jpeg,image/jpg,image/gif"
                                                    onChange={(e) => handleImageUpload(e, 'accountImage')}
                                                    className="w-full p-3 bg-slate-700 text-white rounded-lg border border-slate-600"
                                                />
                                                <p className="text-xs text-gray-400 mt-1">PNG, JPEG, GIF対応</p>
                                            </div>
                                        </div>
                                        
                                        <div className="text-center">
                                            <button
                                                onClick={handleManualDataSubmit}
                                                className="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-8 py-3 rounded-lg font-semibold hover:from-purple-600 hover:to-pink-600 transition-all"
                                            >
                                                次へ進む
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* ステップ1: 動画アップロード */}
                            {currentStep === 1 && (
                                <div className="bg-slate-800/50 backdrop-blur-sm rounded-2xl p-8 border border-slate-700">
                                    <h2 className="text-2xl font-bold text-white mb-6 flex items-center">
                                        <Video />
                                        <span className="ml-3">ゲームプレイ動画をアップロード</span>
                                    </h2>
                                    
                                    <div className="border-2 border-dashed border-slate-600 rounded-xl p-12 text-center hover:border-purple-400 transition-all cursor-pointer"
                                         onClick={() => fileInputRef.current?.click()}>
                                        <Upload />
                                        <p className="text-xl text-gray-300 mb-2 mt-4">
                                            {videoFile ? videoFile.name : 'クリックしてゲームプレイ動画を追加'}
                                        </p>
                                        <p className="text-gray-500">MP4, WebM, MOV対応（最大100MB）</p>
                                    </div>
                                    
                                    <input
                                        ref={fileInputRef}
                                        type="file"
                                        accept="video/*"
                                        onChange={handleVideoUpload}
                                        className="hidden"
                                    />
                                    
                                    {videoFile && (
                                        <div className="mt-6 text-center">
                                            <button
                                                onClick={() => setCurrentStep(2)}
                                                className="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-8 py-3 rounded-lg font-semibold hover:from-purple-600 hover:to-pink-600 transition-all"
                                            >
                                                プレビューを確認
                                            </button>
                                        </div>
                                    )}
                                </div>
                            )}

                            {/* ステップ2: プレビュー */}
                            {currentStep === 2 && gameData && (
                                <div className="bg-slate-800/50 backdrop-blur-sm rounded-2xl p-8 border border-slate-700">
                                    <h2 className="text-2xl font-bold text-white mb-6 flex items-center">
                                        <Play />
                                        <span className="ml-3">プレビュー確認</span>
                                    </h2>
                                    
                                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                                        <div>
                                            <h3 className="text-lg font-semibold text-white mb-4">ゲーム情報</h3>
                                            <div className="bg-slate-700/50 rounded-lg p-4 space-y-3">
                                                <div className="flex items-center">
                                                    <Type />
                                                    <span className="text-gray-300 ml-2">タイトル: </span>
                                                    <span className="text-white font-medium">{gameData.title}</span>
                                                </div>
                                                <div className="flex items-start">
                                                    <Image />
                                                    <span className="text-gray-300 ml-2 mt-0.5">説明: </span>
                                                    <span className="text-white">{gameData.description}</span>
                                                </div>
                                                {gameData.coverImage && (
                                                    <div className="flex items-center">
                                                        <Image />
                                                        <span className="text-gray-300 ml-2">カバー画像: </span>
                                                        <span className="text-green-400">✓ 設定済み</span>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                        
                                        <div>
                                            <h3 className="text-lg font-semibold text-white mb-4">動画ファイル</h3>
                                            <div className="bg-slate-700/50 rounded-lg p-4">
                                                <div className="flex items-center">
                                                    <Video />
                                                    <span className="text-gray-300 ml-2">ファイル名: </span>
                                                    <span className="text-white font-medium">{videoFile?.name}</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div className="mt-8 text-center">
                                        <button
                                            onClick={generateVideo}
                                            className="bg-gradient-to-r from-green-500 to-emerald-500 text-white px-8 py-4 rounded-lg font-semibold text-lg hover:from-green-600 hover:to-emerald-600 transition-all flex items-center mx-auto"
                                        >
                                            <Sparkles />
                                            <span className="ml-2">動画を生成する</span>
                                        </button>
                                    </div>
                                </div>
                            )}

                            {/* ステップ3: 生成中・完了 */}
                            {currentStep === 3 && (
                                <div className="bg-slate-800/50 backdrop-blur-sm rounded-2xl p-8 border border-slate-700">
                                    {isProcessing ? (
                                        <div className="text-center px-4 md:px-0">
                                            <h2 className="text-xl md:text-2xl font-bold text-white mb-6">動画を生成中...</h2>
                                            <div className="w-full bg-slate-700 rounded-full h-4 mb-4">
                                                <div 
                                                    className="bg-gradient-to-r from-purple-500 to-pink-500 h-4 rounded-full transition-all duration-300"
                                                    style={{ width: `${progress}%` }}
                                                ></div>
                                            </div>
                                            <p className="text-gray-300">{progress}% 完了</p>
                                        </div>
                                    ) : errorMessage ? (
                                        <div className="text-center px-4 md:px-0">
                                            <h2 className="text-xl md:text-2xl font-bold text-red-400 mb-6">エラーが発生しました</h2>
                                            <p className="text-gray-300 mb-6">{errorMessage}</p>
                                            <button
                                                onClick={() => {
                                                    setCurrentStep(2);
                                                    setErrorMessage('');
                                                }}
                                                className="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-6 md:px-8 py-3 rounded-lg font-semibold hover:from-purple-600 hover:to-pink-600 transition-all w-full md:w-auto"
                                            >
                                                再試行
                                            </button>
                                        </div>
                                    ) : outputVideo ? (
                                        <div className="text-center px-4 md:px-0">
                                            <h2 className="text-xl md:text-2xl font-bold text-white mb-6 flex flex-col md:flex-row items-center justify-center">
                                                <Sparkles />
                                                <span className="mt-2 md:mt-0 md:ml-3">動画生成完了！</span>
                                            </h2>
                                            <div className="mb-6">
                                                <video
                                                    controls
                                                    className="mx-auto rounded-lg w-full max-w-md"
                                                    src={outputVideo}
                                                />
                                            </div>
                                            <a
                                                href={outputVideo}
                                                download={`dreamcore-video.${outputVideoMimeType?.includes('mp4') ? 'mp4' : 'webm'}`}
                                                className="bg-gradient-to-r from-green-500 to-emerald-500 text-white px-6 md:px-8 py-3 md:py-4 rounded-lg font-semibold text-base md:text-lg hover:from-green-600 hover:to-emerald-600 transition-all inline-flex items-center w-full md:w-auto justify-center"
                                            >
                                                <Download />
                                                <span className="ml-2">動画をダウンロード</span>
                                            </a>
                                            <div className="mt-6">
                                                <button
                                                    onClick={() => {
                                                        setCurrentStep(0);
                                                        setGameData(null);
                                                        setVideoFile(null);
                                                        setOutputVideo(null);
                                                        setOutputVideoMimeType(null);
                                                        setErrorMessage('');
                                                        setManualData({ title: '', description: '', coverImage: null, accountImage: null });
                                                    }}
                                                    className="text-purple-400 hover:text-purple-300 transition-all text-base md:text-lg"
                                                >
                                                    新しい動画を作成
                                                </button>
                                            </div>
                                        </div>
                                    ) : null}
                                </div>
                            )}
                        </div>
                    </div>

                    {/* Hidden Canvas for video generation */}
                    <canvas 
                        ref={canvasRef} 
                        className="hidden"
                        width="1000"
                        height="1000"
                        style={{ width: '1000px', height: '1000px' }}
                    />
                    
                    {/* フッター */}
                    <footer className="mt-12 py-6 border-t border-slate-700 bg-slate-800/30">
                        <div className="container mx-auto px-6 text-center">
                            <p className="text-gray-400 text-sm">
                                Developed by{' '}
                                <a 
                                    href="https://x.com/suemaruuuuuuX" 
                                    target="_blank" 
                                    rel="noopener noreferrer"
                                    className="text-blue-400 hover:text-blue-300 transition-all font-medium"
                                >
                                    @suemaruuuuuuX
                                </a>
                                {' '}| フォローお願いします！！
                            </p>
                        </div>
                    </footer>
                </div>
            );
        };

        ReactDOM.render(<DreamCoreVideoGenerator />, document.getElementById('root'));
    </script>
</body>
</html>